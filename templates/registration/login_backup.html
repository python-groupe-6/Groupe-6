{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Connexion - EduQuiz AI{% endblock %}

{% block extra_css %}
<link href="{% static 'css/login.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-card animate-in">
        <div class="login-header">
            <div class="login-logo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 class="login-title">Bon retour</h1>
            <p class="login-subtitle">Connectez-vous à votre espace EduQuiz AI</p>
        </div>

        <form method="post" class="needs-validation" novalidate id="loginForm">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="alert alert-danger small mb-3 p-2 rounded-3 border-0 bg-danger-subtle text-danger">
                {% for error in form.non_field_errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-group">
                <label for="id_username" class="form-label">Nom d'utilisateur</label>
                <input type="text" name="username" autofocus autocapitalize="none" autocomplete="username"
                    maxlength="150" required id="id_username"
                    class="form-control-custom {% if form.username.errors %}is-invalid{% endif %}">
                {% if form.username.errors %}
                <div class="invalid-feedback d-block small mt-1">
                    {{ form.username.errors.0 }}
                </div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="id_password" class="form-label">Mot de passe</label>
                <input type="password" name="password" autocomplete="current-password" required id="id_password"
                    class="form-control-custom {% if form.password.errors %}is-invalid{% endif %}">
                <button type="button" class="password-toggle" onclick="togglePasswordVisibility()"
                    aria-label="Afficher le mot de passe">
                    <i class="far fa-eye" id="toggleIcon"></i>
                </button>
                {% if form.password.errors %}
                <div class="invalid-feedback d-block small mt-1">
                    {{ form.password.errors.0 }}
                </div>
                {% endif %}
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="form-check-custom">
                    <input class="form-check-input-custom" type="checkbox" id="rememberMe">
                    <label class="form-check-label-custom" for="rememberMe">
                        Rester connecté
                    </label>
                </div>
                <a href="{% url 'accounts:password_reset' %}" class="forgot-password-link">Mot de passe oublié ?</a>
            </div>

            <button type="submit" class="btn-login" id="submitBtn">
                <span class="btn-text">Se connecter</span>
                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>
        </form>

        <div class="login-footer">
            <p>Pas encore de compte ? <a href="{% url 'accounts:register' %}">Créer un compte</a></p>
        </div>
    </div>
</div>

<script>
    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('id_password');
        const toggleIcon = document.getElementById('toggleIcon');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }

    // Loading state for submitting
    document.getElementById('loginForm').addEventListener('submit', function () {
        const btn = document.getElementById('submitBtn');
        const spinner = btn.querySelector('.spinner-border');
        const text = btn.querySelector('.btn-text');

        btn.disabled = true;
        spinner.classList.remove('d-none');
        text.textContent = 'Connexion...';
    });
</script>
{% endblock %}
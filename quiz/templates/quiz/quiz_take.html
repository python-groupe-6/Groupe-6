{% extends 'base.html' %}

{% block content %}
<div class="container animate-fade-in" style="max-width: 800px;">
    <div class="text-center mb-5">
        <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2 mb-3">Mode √âvaluation</span>
        <h2 class="brand-font display-6">√Ä vous de jouer !</h2>
        <p class="text-muted">Prenez le temps de bien lire chaque question.</p>

        <!-- Timer Display -->
        <div class="sticky-top pt-3" style="z-index: 1020;">
            <div
                class="d-inline-flex align-items-center gap-3 bg-white shadow-lg border border-primary-subtle rounded-pill px-4 py-2 animate-pulse-slow">
                <span class="fs-4">‚è±Ô∏è</span>
                <span id="timerDisplay" class="brand-font fs-4 text-primary fw-bold">00:00</span>
            </div>
        </div>
    </div>

    <form method="post" id="quizForm" data-time-limit="{{ quiz_obj.time_limit|default:5 }}">
        {% csrf_token %}
        <input type="hidden" name="time_elapsed" id="timeElapsedInput" value="00:00">

        {% for q in quiz_data %}
        <div class="card mb-4 border-0 shadow-sm rounded-4 overflow-hidden hover-shadow transition-all">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-center gap-2 mb-4">
                    <span class="badge rounded-pill bg-primary px-3 py-2 fw-bold" style="font-size: 0.75rem;">QUESTION
                        {{ forloop.counter }}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="card-title text-dark mb-0 fw-bold" style="font-size: 1.25rem;">{{ q.text }}</h5>
                    {% if not quiz_obj.is_exam_mode %}
                    <button type="button" class="btn btn-outline-primary btn-sm rounded-circle audio-btn"
                        onclick="playAudio('{{ q.text|escapejs }}', this)" title="√âcouter la question">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="d-flex flex-column gap-3">
                    {% for option in q.options %}
                    <label class="option-label position-relative">
                        <input class="form-check-input position-absolute opacity-0" type="radio"
                            name="question_{{ forloop.parentloop.counter0 }}" value="{{ option }}" required>
                        <div
                            class="d-flex align-items-center gap-3 p-3 border rounded-4 cursor-pointer transition-all bg-light bg-opacity-50 hover-bg-white border-light-subtle shadow-sm-hover">
                            <div class="custom-radio-indicator border rounded-circle d-flex align-items-center justify-content-center"
                                style="width: 22px; height: 22px; transition: all 0.2s;"></div>
                            <span class="fs-6 text-dark opacity-75">{{ option }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="d-grid gap-2 mt-5 mb-5">
            <button type="submit" class="btn btn-success btn-lg rounded-pill fw-bold py-3 shadow-lg transform-hover">
                Valider mes r√©ponses üöÄ
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const quizForm = document.getElementById('quizForm');
        const timeElapsedInput = document.getElementById('timeElapsedInput');
        const timerDisplay = document.getElementById('timerDisplay');
        const timeLimitMinutes = parseInt(quizForm.getAttribute('data-time-limit') || '5');

        let timeLeftSeconds = timeLimitMinutes * 60;
        let timeElapsedSeconds = 0;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        const timerInterval = setInterval(function () {
            timeLeftSeconds--;
            timeElapsedSeconds++;

            // Update display
            timerDisplay.textContent = formatTime(timeLeftSeconds);
            timeElapsedInput.value = formatTime(timeElapsedSeconds);

            // Warning colors
            if (timeLeftSeconds <= 60) {
                timerDisplay.classList.remove('text-primary');
                timerDisplay.classList.add('text-danger');
            }

            // Time's up
            if (timeLeftSeconds <= 0) {
                clearInterval(timerInterval);
                alert("Temps √©coul√© ! Vos r√©ponses vont √™tre envoy√©es.");
                quizForm.submit();
            }
        }, 1000);

        // Initial display
        // Audio Logic
        const currentAudio = new Audio();

        window.playAudio = function (text, btn) {
            if (!text) return;

            const icon = btn.querySelector('i');
            if (currentAudio.src && !currentAudio.paused) {
                currentAudio.pause();
                resetAudioButtons();
                if (currentAudio.textPlaying === text) return;
            }

            btn.classList.add('btn-primary');
            btn.classList.remove('btn-outline-primary');
            icon.className = 'fas fa-spinner fa-spin';

            currentAudio.src = `{% url 'quiz:generate_audio' %}?text=${encodeURIComponent(text)}`;
            currentAudio.textPlaying = text;

            currentAudio.play().then(() => {
                icon.className = 'fas fa-stop';
            }).catch(err => {
                console.error("Audio error:", err);
                resetAudioButtons();
            });

            currentAudio.onended = resetAudioButtons;
        };

        function resetAudioButtons() {
            document.querySelectorAll('.audio-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-primary');
                b.querySelector('i').className = 'fas fa-volume-up';
            });
        }
    });
</script>

<style>
    .animate-pulse-slow {
        animation: pulse-slow 3s infinite;
    }

    @keyframes pulse-slow {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.02);
        }
    }

    /* Custom Radio Styles for this page */
    .option-label input:checked+div {
        border-color: var(--primary) !important;
        background-color: rgba(79, 70, 229, 0.05) !important;
    }

    .option-label input:checked+div .custom-radio-indicator {
        border-color: var(--primary) !important;
        background-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }

    .option-label input:checked+div span {
        color: var(--primary) !important;
        font-weight: 600;
    }

    .hover-shadow:hover {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08) !important;
        transform: translateY(-2px);
    }

    .transition-all {
        transition: all 0.2s ease;
    }

    .transform-hover:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}